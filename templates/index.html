<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Eye Tracking Experiment</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: white;
            font-family: sans-serif;
        }
        #gazeDot {
            position: absolute;
            width: 15px;
            height: 15px;
            background: red;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
        }
        .calibration-dot {
            width: 20px;
            height: 20px;
            background: blue;
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
        }
        .stim-img {
            position: absolute;
            width: 50vw;
            height: 50vh;
            object-fit: contain;
            z-index: 10;
        }
        #overlay-buttons {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 30;
        }
    </style>
</head>
<body>

<div id="gazeDot"></div>

<!-- Welcome screen -->
<div id="welcome" style="position:absolute;top:30%;left:10%;width:80%;text-align:center;z-index:50;">
    <h1>Welcome to the Eye Tracking Experiment</h1>
    <p>Click below to begin calibration.</p>
    <button onclick="startCalibration()">Start Calibration</button>
</div>

<!-- Experiment area -->
<div id="experiment" style="display:none;">
    <img id="img1" class="stim-img" src="{{ url_for('static', filename='dropper.png') }}">
    <img id="img2" class="stim-img" src="{{ url_for('static', filename='swab.png') }}">
    <img id="img3" class="stim-img" src="{{ url_for('static', filename='test_tube.png') }}">
    <img id="img4" class="stim-img" src="{{ url_for('static', filename='test_cassette.png') }}">
</div>

<!-- Buttons -->
<div id="overlay-buttons" style="display:none;">
    <button id="playBtn" onclick="playAudio()">Play Sound</button>
    <button id="saveBtn" onclick="saveData()" style="display:none;">End Experiment / Save Data</button>
</div>

<audio id="stimulusAudio" src="{{ url_for('static', filename='all_casual.wav') }}"></audio>

<script src="{{ url_for('static', filename='webgazer.js') }}"></script>
<script>
    let isCalibrating = false;
    let gazeData = [];
    let gazeBuffer = [];  // Buffer to collect gaze points each second
    let averageTimer;

    webgazer.setGazeListener((data, timestamp) => {
        if (!data) return;

        // Move red dot
        const dot = document.getElementById('gazeDot');
        dot.style.left = data.x + "px";
        dot.style.top = data.y + "px";

        // Only buffer data if NOT calibrating
        if (!isCalibrating) {
            gazeBuffer.push({
                x: data.x,
                y: data.y,
                t: timestamp
            });
        }
    });

    function startCalibration() {
        isCalibrating = true;
        document.getElementById('welcome').style.display = 'none';
        document.getElementById('experiment').style.display = 'block';

        webgazer.begin()
            .then(() => {
                webgazer.showVideo(true);
                webgazer.showFaceOverlay(true);
                webgazer.showFaceFeedbackBox(true);

                // Place calibration dots
                const points = [
                    [5,5], [50,5], [95,5],
                    [5,50], [50,50], [95,50],
                    [5,95], [50,95], [95,95]
                ];
                let clicked = 0;
                points.forEach(pos => {
                    const dot = document.createElement("div");
                    dot.className = "calibration-dot";
                    dot.style.left = pos[0] + "vw";
                    dot.style.top = pos[1] + "vh";
                    dot.onclick = () => {
                        dot.style.background = 'gray';
                        clicked++;
                        if (clicked === 9) finishCalibration();
                    };
                    document.body.appendChild(dot);
                });

                // Position images
                const w = window.innerWidth / 2;
                const h = window.innerHeight / 2;
                document.getElementById('img1').style.left = "0px";
                document.getElementById('img1').style.top = "0px";
                document.getElementById('img2').style.left = w + "px";
                document.getElementById('img2').style.top = "0px";
                document.getElementById('img3').style.left = "0px";
                document.getElementById('img3').style.top = h + "px";
                document.getElementById('img4').style.left = w + "px";
                document.getElementById('img4').style.top = h + "px";
            });
    }

    function finishCalibration() {
        isCalibrating = false;
        document.querySelectorAll('.calibration-dot').forEach(dot => dot.remove());
        document.body.style.cursor = 'none';
        document.getElementById('overlay-buttons').style.display = 'block';

        // Hide face overlay and red dot
        webgazer.showVideo(false);
        webgazer.showFaceOverlay(false);
        webgazer.showFaceFeedbackBox(false);
        document.getElementById('gazeDot').style.display = 'none';
    }

    function playAudio() {
        document.getElementById('playBtn').style.display = 'none';
        const audio = document.getElementById('stimulusAudio');
        audio.play();

        // Start averaging gaze data every second
        averageTimer = setInterval(() => {
            if (gazeBuffer.length > 0) {
                let avgX = gazeBuffer.reduce((sum, d) => sum + d.x, 0) / gazeBuffer.length;
                let avgY = gazeBuffer.reduce((sum, d) => sum + d.y, 0) / gazeBuffer.length;
                let avgTime = gazeBuffer[gazeBuffer.length - 1].t / 1000;  // convert to seconds

                gazeData.push({
                    x: avgX,
                    y: avgY,
                    time_sec: avgTime,
                    normX: 4 * (avgX / window.innerWidth - 0.5),
                    normY: 4 * (avgY / window.innerHeight - 0.5)
                });

                gazeBuffer = [];  // Reset buffer for next second
            }
        }, 1000);

        audio.onended = () => {
            clearInterval(averageTimer); // Stop averaging when audio ends
            document.getElementById('saveBtn').style.display = 'inline';
        };
    }

    function saveData() {
        const pid = prompt("Enter participant ID:");
        const initials = prompt("Enter your initials:");
        fetch('/save_gaze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                gaze: gazeData, 
                participant_id: pid, 
                initials: initials 
            })
        }).then(() => {
            alert('Gaze data saved successfully!');
        });
    }
</script>
</body>
</html>