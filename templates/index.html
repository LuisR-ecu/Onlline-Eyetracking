<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Eye Tracking Experiment</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: white;
            font-family: sans-serif;
        }
        #gazeDot {
            position: absolute;
            width: 15px;
            height: 15px;
            background: red;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
        }
        .calibration-dot {
            width: 20px;
            height: 20px;
            background: blue;
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
        }
        .stim-img {
            position: absolute;
            width: 50vw;
            height: 50vh;
            object-fit: contain;
            z-index: 10;
        }
        #overlay-buttons {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 30;
        }
    </style>
</head>
<body>

<div id="gazeDot"></div>

<!-- Welcome screen -->
<div id="welcome" style="position:absolute;top:30%;left:10%;width:80%;text-align:center;z-index:50;">
    <h1>Welcome to the Eye Tracking Experiment</h1>
    <p>Click below to begin calibration.</p>
    <button onclick="startCalibration()">Start Calibration</button>
</div>

<!-- Experiment area (real images shown from start) -->
<div id="experiment" style="display:none;">
    <img id="img1" class="stim-img" src="{{ url_for('static', filename='dropper.png') }}">
    <img id="img2" class="stim-img" src="{{ url_for('static', filename='swab.png') }}">
    <img id="img3" class="stim-img" src="{{ url_for('static', filename='test_tube.png') }}">
    <img id="img4" class="stim-img" src="{{ url_for('static', filename='test_cassette.png') }}">
</div>

<!-- Buttons appear only when needed -->
<div id="overlay-buttons" style="display:none;">
    <button id="playBtn" onclick="playAudio()">Play Sound</button>
    <button id="saveBtn" onclick="saveData()" style="display:none;">End Experiment / Save Data</button>
</div>

<audio id="stimulusAudio" src="{{ url_for('static', filename='all_casual.wav') }}"></audio>

<script src="{{ url_for('static', filename='webgazer.js') }}"></script>
<script>
    let isCalibrating = false;
    let gazeData = [];

    // Update gaze dot and collect gaze data
    webgazer.setGazeListener((data, timestamp) => {
        if (!data) return;
        const dot = document.getElementById('gazeDot');
        dot.style.left = data.x + "px";
        dot.style.top = data.y + "px";

        if (!isCalibrating) {
            gazeData.push({
                x: data.x,
                y: data.y,
                t: timestamp,
                normX: 4 * (data.x / window.innerWidth - 0.5),
                normY: 4 * (data.y / window.innerHeight - 0.5)
            });
        }
    });

    // Start calibration
    function startCalibration() {
        isCalibrating = true;
        document.getElementById('welcome').style.display = 'none';
        document.getElementById('experiment').style.display = 'block';

        webgazer.begin()
            .then(() => {
                webgazer.showVideo(true);
                webgazer.showFaceOverlay(true);
                webgazer.showFaceFeedbackBox(true);

                // Create calibration dots
                const points = [
                    [5,5], [50,5], [95,5],
                    [5,50], [50,50], [95,50],
                    [5,95], [50,95], [95,95]
                ];
                let clicked = 0;
                points.forEach(pos => {
                    const dot = document.createElement("div");
                    dot.className = "calibration-dot";
                    dot.style.left = pos[0] + "vw";
                    dot.style.top = pos[1] + "vh";
                    dot.onclick = () => {
                        dot.style.background = 'gray';
                        clicked++;
                        if (clicked === 9) finishCalibration();
                    };
                    document.body.appendChild(dot);
                });

                // Arrange images immediately in 2x2 grid
                const w = window.innerWidth / 2;
                const h = window.innerHeight / 2;
                document.getElementById('img1').style.left = "0px";
                document.getElementById('img1').style.top = "0px";
                document.getElementById('img2').style.left = w + "px";
                document.getElementById('img2').style.top = "0px";
                document.getElementById('img3').style.left = "0px";
                document.getElementById('img3').style.top = h + "px";
                document.getElementById('img4').style.left = w + "px";
                document.getElementById('img4').style.top = h + "px";
            });
    }

    // Finish calibration
    function finishCalibration() {
        isCalibrating = false;

        // Hide the calibration dots
        document.querySelectorAll('.calibration-dot').forEach(dot => dot.remove());

        // Hide mouse cursor
        document.body.style.cursor = 'none';

        // Show Play button
        document.getElementById('overlay-buttons').style.display = 'block';
    }

    // Play sound and show save button after audio ends
    function playAudio() {
        document.getElementById('playBtn').style.display = 'none';
        const audio = document.getElementById('stimulusAudio');
        audio.play();
        audio.onended = () => {
            document.getElementById('saveBtn').style.display = 'inline';
        };
    }

    // Save gaze data to backend
    function saveData() {
        fetch('/save_gaze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gaze: gazeData })
        }).then(() => {
            alert('Gaze data saved successfully!');
        });
    }
</script>
</body>
</html>