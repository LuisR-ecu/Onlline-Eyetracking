<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Eye Tracking Experiment</title>
    <style>
        body { margin: 0; overflow: hidden; background: white; font-family: sans-serif; }
        #gazeDot { position: absolute; width: 15px; height: 15px; background: red; border-radius: 50%; pointer-events: none; z-index: 9999; }
        .stim-img { position: absolute; width: 49vw; height: 49vh; object-fit: contain; z-index: 10; }
        #overlay-buttons { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 30; }
    </style>
</head>
<body>

<div id="gazeDot"></div>

<div id="welcome" style="position:absolute;top:10%;left:10%;width:80%;text-align:center;z-index:50;">
    <h1>Welcome to the Eye Tracking Experiment</h1>
    <p>By continuing, you consent to participate in this study.</p>
    <p>Enter Participant ID and Initials:</p>
    <input type="text" id="pid" placeholder="Participant ID"><br><br>
    <input type="text" id="initials" placeholder="Initials"><br><br>
    <p>Age: <input type="number" id="age"> Gender: <input type="text" id="gender"></p>
    <button onclick="startCalibration()">Start Calibration</button>
</div>

<div id="experiment" style="display:none;">
    <img id="img1" class="stim-img" src="{{ url_for('static', filename='dropper.png') }}">
    <img id="img2" class="stim-img" src="{{ url_for('static', filename='swab.png') }}">
    <img id="img3" class="stim-img" src="{{ url_for('static', filename='test_tube.png') }}">
    <img id="img4" class="stim-img" src="{{ url_for('static', filename='test_cassette.png') }}">
</div>

<div id="overlay-buttons" style="display:none;">
    <button id="nextTrialBtn" onclick="startTrial()">Start Trial</button>
</div>

<audio id="audioFast" src="{{ url_for('static', filename='rushed.wav') }}"></audio>
<audio id="audioSlow" src="{{ url_for('static', filename='all_casual.wav') }}"></audio>

<script src="{{ url_for('static', filename='webgazer.js') }}"></script>
<script>
let gazeData = [];
let trialNum = 0;
let NUM_TRIALS = 20;  // Change this to reduce trials for testing
let isCalibrating = false;
let instructionStartTime = null;
let reactionRecorded = false;
let trialOrder = [];
let demographics = {};

const imgIds = ["img1", "img2", "img3", "img4"];
const audioTypes = ["silent", "fast", "slow"];
const instructionText = "Please locate the correct image as per the instructions.";

// Randomize trials in advance
for (let i = 0; i < NUM_TRIALS; i++) {
    trialOrder.push(audioTypes[Math.floor(Math.random() * audioTypes.length)]);
}

webgazer.setGazeListener((data, timestamp) => {
    if (!data) return;
    const dot = document.getElementById('gazeDot');
    dot.style.left = data.x + "px";
    dot.style.top = data.y + "px";

    if (!isCalibrating && instructionStartTime !== null) {
        const elapsed = (Date.now() - instructionStartTime) / 1000;

        const lookedAtTarget = isInTargetArea(data.x, data.y);
        if (lookedAtTarget && !reactionRecorded) {
            reactionRecorded = elapsed;
        }

        gazeData.push({
            trial: trialNum,
            time: elapsed.toFixed(2),
            x: data.x,
            y: data.y,
            normX: 4 * (data.x / window.innerWidth - 0.5),
            normY: 4 * (data.y / window.innerHeight - 0.5),
            lookedAtTarget: lookedAtTarget,
            reactionTime: reactionRecorded || "N/A"
        });
    }
});

// --- Calibration ---
function startCalibration() {
    isCalibrating = true;

    demographics.pid = document.getElementById('pid').value;
    demographics.initials = document.getElementById('initials').value;
    demographics.age = document.getElementById('age').value;
    demographics.gender = document.getElementById('gender').value;

    document.getElementById('welcome').style.display = 'none';
    document.getElementById('experiment').style.display = 'block';
    document.getElementById('overlay-buttons').style.display = 'block';

    webgazer.begin().then(() => {
        webgazer.showVideo(true);
        webgazer.showFaceOverlay(true);
        webgazer.showFaceFeedbackBox(true);
    });
}

// --- Trial Logic ---
function startTrial() {
    if (trialNum >= NUM_TRIALS) {
        endExperiment();
        return;
    }

    reactionRecorded = false;
    instructionStartTime = Date.now();

    // Layout images
    if (trialOrder[trialNum] === "silent") {
        orderedLayout();
    } else {
        randomLayout();
    }

    // Hide facecam and red dot during trials
    webgazer.showFaceOverlay(false);
    webgazer.showFaceFeedbackBox(false);
    document.getElementById('gazeDot').style.display = 'none';

    // Play audio if needed
    if (trialOrder[trialNum] === "fast") {
        document.getElementById('audioFast').play();
    } else if (trialOrder[trialNum] === "slow") {
        document.getElementById('audioSlow').play();
    }

    document.getElementById('nextTrialBtn').style.display = 'none';

    // Show next trial button after 8 seconds
    setTimeout(() => {
        trialNum++;
        document.getElementById('nextTrialBtn').style.display = 'inline';
    }, 8000);
}

// --- Layout functions ---
function orderedLayout() {
    document.getElementById('img1').style.left = "0px";
    document.getElementById('img1').style.top = "0px";
    document.getElementById('img2').style.left = window.innerWidth/2 + "px";
    document.getElementById('img2').style.top = "0px";
    document.getElementById('img3').style.left = "0px";
    document.getElementById('img3').style.top = window.innerHeight/2 + "px";
    document.getElementById('img4').style.left = window.innerWidth/2 + "px";
    document.getElementById('img4').style.top = window.innerHeight/2 + "px";
}

function randomLayout() {
    let positions = [
        ["0px","0px"],
        [window.innerWidth/2 + "px", "0px"],
        ["0px", window.innerHeight/2 + "px"],
        [window.innerWidth/2 + "px", window.innerHeight/2 + "px"]
    ];
    positions = positions.sort(() => Math.random() - 0.5);

    imgIds.forEach((img, idx) => {
        document.getElementById(img).style.left = positions[idx][0];
        document.getElementById(img).style.top = positions[idx][1];
    });
}

function isInTargetArea(x, y) {
    // We'll assume img1 is always the "correct" target
    const rect = document.getElementById('img1').getBoundingClientRect();
    return (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
}

// --- End experiment ---
function endExperiment() {
    fetch('/save_gaze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            gaze: gazeData,
            demographics: demographics
        })
    }).then(() => {
        alert('Data saved successfully!');
    });
}
</script>
</body>
</html>